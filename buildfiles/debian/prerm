#!/bin/bash
# prerm script for pi-web-agent
#
# see: dh_installdeb(1)
set -e
SERVICE_PATH="etc/init.d"
APPLICATION_PATH="usr/libexec/pi-web-agent"
DEPENDENCIES="git tightvncserver apache2 libapache2-mod-dnssd alsa-utils python gcc libprocps0-dev"
VNC_SERVICE="etc/init.d/vncboot"
ETC_PATH="etc/pi-web-agent"
LOGS=/var/log/pi-web-agent
SHARE="usr/share/pi-web-agent"
PI_UPDATE=usr/bin/pi-update
PI_UPGRADE=usr/bin/pi-upgrade
PI_FIX=usr/bin/pi-fix
APT_QUERY=usr/bin/apt-query
SUDOERS_D=etc/sudoers.d/pi-web-agent
GPIO_QUERY=usr/bin/gpio-query
CRON_JOBS=etc/cron.daily
EXECUTE_BIN=usr/bin/execute-pwa.sh
PI_APT=usr/bin/pi-package-management
htpasswd_PATH=usr/libexec/pi-web-agent/.htpasswd
UPDATE_APP_BIN=usr/bin/pi-web-agent-update
UPDATE_CHECK_PY=usr/bin/update_check.py
OTHER_BINS="usr/bin/start-stream-cam.sh usr/bin/pi-camera-stream.sh"
SYSTEM_UPDATE_CHECK=usr/bin/system_update_check.sh
STARTUP_PWA=usr/bin/startup-manager-pwa.py
CRONJOB_REBOOT=/etc/cron.d/cronpwa
# summary of how this script can be called:
#        * <prerm> `remove'
#        * <old-prerm> `upgrade' <new-version>
#        * <new-prerm> `failed-upgrade' <old-version>
#        * <conflictor's-prerm> `remove' `in-favour' <package> <new-version>
#        * <deconfigured's-prerm> `deconfigure' `in-favour'
#          <package-being-installed> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
print_ok() {
msg="OK"
[ -n "$1" ] && {
   msg=$1
} 
echo -e "[ \e[1;32m $msg \e[0m ]"

}

print_error() {
    echo -e "[ \e[1;31m $1 \e[0m ]"
}

print_warning() {
   echo -e "[ \e[1;33m $1 \e[0m ]"    
}
this_uninstall() {
    echo -n "Stopping pi web agent apache instance daemon " 
    this_safe_stop_service pi-web-agent
    this_safe_remove "/$APPLICATION_PATH"

    this_safe_remove "/$ETC_PATH"
    this_safe_remove "/$SERVICE_PATH"
    this_safe_remove "/$SHARE"
    this_safe_remove "/$EXECUTE_BIN"
    this_safe_remove "/usr/bin/execute.sh"
    this_safe_remove "/$PI_APT"
    
    this_safe_remove "/$UPDATE_CHECK_PY"
    this_safe_remove "/$UPDATE_APP_BIN"
    this_safe_remove "/$SYSTEM_UPDATE_CHECK"
    this_safe_remove $CRONJOB_REBOOT
    this_safe_remove "/$STARTUP_PWA"
    this_safe_stop_service vncboot;
    this_safe_remove /etc/init.d/vncboot

    print_ok
    echo "Deleting user account of appliance..."
    this_safe_remove  /$SUDOERS_D
    this_safe_remove /etc/pi-web-agent
    userdel -f pi-web-agent|| print_error "no existing pwa user"
    print_ok "DONE"
}
this_safe_stop_service(){
    echo -n "Stopping $1  daemon "
    if (( $(ps -ef | grep -v grep | grep "$1" | wc -l) > 0 ))
    then
       sudo "/$SERVICE_PATH/$1" stop&&print_ok "service stoped"||\
       print_error "could not stop service"
    else
       print_ok   "service not running"
    fi 
}
this_safe_remove() {
    echo "attempting to remove $1"
    [[ -f "$1" || -d "$1" ]] && /bin/rm -r "$1"&&print_ok || print_error "FAILED"
    
}

case "$1" in
    remove|upgrade|deconfigure)
	this_uninstall
    ;;

    failed-upgrade)
    ;;

    *)
        echo "prerm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
